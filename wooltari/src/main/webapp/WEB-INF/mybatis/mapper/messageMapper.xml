<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="message">
	<!-- 메시지 전송 -->
	<insert id="sendMessage" parameterType="com.wooltari.message.Message">
		INSERT INTO message(num, sendUserId, receiveUserId, content) VALUES (message_seq.NEXTVAL, #{sendUserID}, #{receiveUserID}, #{content})
    </insert>
    
    <sql id="where-mode">
		<if test="mode=='receive'">
		receiveUserId = #{userId}
		</if>
		<if test="mode=='send'">
		sendUserId = #{userId}
		</if>
		<if test="mode=='keep'">
		receiveUserId = #{userId}
		</if>
		<if test="mode=='trash'">
		receiveUserId = #{userId}
		</if>
	</sql>
	
	<sql id="where-value">
		<if test="searchValue != null and searchValue != ''">
 		AND DBMS_LOB.INSTR(content, #{searchValue}) &gt; 0 
		</if>
	</sql>
	
    <!-- 메시지 개수 -->
	<select id="dataCount" parameterType="map" resultType="Integer">
		SELECT NVL(COUNT(*), 0) FROM message
		<where>
			<include refid="where-mode"/>
	    </where>
	</select>
	
	<!-- 쪽지 리스트 -->
	<select id="listMessage" parameterType="map" resultType="com.wooltari.message.Message">
		SELECT * FROM (
		    SELECT ROWNUM rnum, tb.* FROM (
				SELECT num, sendUserId, receiveUserId, content, sendDate, readDate, read
				FROM message
            <where>
				<include refid="where-mode"/>
				<include refid="where-value"/>
	    	</where>
            ORDER BY num DESC
	<![CDATA[
	        ) tb WHERE ROWNUM <= #{end}
	    ) WHERE rnum >= #{start}
	]]>
	</select>
	
	<!-- 쪽지 보기 -->
	<select id="readMessage" resultType="com.wooltari.message.Message" parameterType="Integer">
		SELECT num, sendUserId, receiveUserId, content, sendDate, readDate, read
		FROM message
		WHERE num = #{num}
	</select>
	
	<!-- 읽은 쪽지 처리 -->
	<update id="updateReadMessage" parameterType="Integer">
		UPDATE message SET read=0 WHERE num = #{num}
	</update>
	
	<!-- 보관함 이동 처리 -->
	<update id="updateHoldMessage" parameterType="Integer">
		UPDATE message SET category=2 WHERE num = #{num}
	</update>
	
	<!-- 휴지통 이동 처리 -->
	<update id="updateTrashMessage" parameterType="Integer">
		UPDATE message SET category=0 WHERE num = #{num}
	</update>
	
	
	
</mapper>